{% extends 'base.html' %}
{% load static %}
{% block title %}Editar Producto{% endblock %}
{% block content %}
<style>
    .producto-edit-section {
        max-width: 650px;
        margin: 40px auto;
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 2px 16px 0 rgba(60,72,88,.10);
        padding: 2.5rem 2rem 2rem 2rem;
    }
    .producto-edit-title {
        color: #2563eb;
        font-weight: 700;
        margin-bottom: 1.5rem;
        letter-spacing: 1px;
        text-align: center;
    }
    .producto-edit-form label {
        color: #334155;
        font-weight: 500;
        margin-bottom: 0.3rem;
    }
    .producto-edit-form input,
    .producto-edit-form select {
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        margin-bottom: 1rem;
    }
    .producto-edit-btn {
        border-radius: 8px;
        font-weight: 600;
        background: #2563eb;
        color: #fff;
        border: none;
        padding: 0.6rem 1.5rem;
        margin-right: 0.7rem;
        transition: background .2s;
    }
    .producto-edit-btn:hover {
        background: #1e40af;
        color: #fff;
    }
    .producto-edit-btn-danger {
        background: #ef4444;
    }
    .producto-edit-btn-danger:hover {
        background: #b91c1c;
    }
    .producto-edit-divider {
        border-top: 1px solid #e5e7eb;
        margin: 1.5rem 0;
    }
    .producto-edit-img-preview {
        border: 2px solid #2563eb;
        border-radius: 12px;
        width: 100%;
        max-width: 260px;
        margin-bottom: 0.7rem;
        object-fit: cover;
    }
    .promociones-contenedor {
        margin-top: 2rem;
    }
</style>
<div class="producto-edit-section">
    <h2 class="producto-edit-title"><i class="fa-solid fa-pen-to-square me-2"></i>Editar Producto</h2>
    <form action="{% url 'actualizar_producto' producto_tienda.id %}" method="POST" enctype="multipart/form-data" class="producto-edit-form">
        {% csrf_token %}
                {% if form.errors %}
            <div class="alert alert-danger">
                <ul>
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        <div class="row mb-4">
            <div class="col-md-4 text-center">
                {% if producto_tienda.imagen %}
                    <img id="imagen-preview" src="{{ producto_tienda.imagen.url }}" alt="{{ producto_tienda.producto.nombre }}" class="producto-edit-img-preview">
                    <p id="imagen-status">Imagen Actual</p>
                {% else %}
                    <img id="imagen-preview" src="{% static 'default-image.png' %}" alt="Imagen Predeterminada" class="producto-edit-img-preview">
                    <p id="imagen-status">Sin Imagen Actual</p>
                {% endif %}
                <label for="imagen" class="form-label">Actualizar Imagen:</label>
                <input type="file" id="imagen" name="imagen" class="form-control" onchange="previewImage(event)">
            </div>
            <div class="col-md-8">
                <label for="txtProductoId" class="form-label">Nombre del producto:</label>
                <select id="txtProductoId" name="producto" class="form-select" required>
                    <option value="{{ producto_tienda.producto.id }}" selected>{{ producto_tienda.producto.nombre }}</option>
                    {% for producto in productos %}
                        <option value="{{ producto.id }}">{{ producto.nombre }}</option>
                    {% endfor %}
                </select>
                <label for="txtProveedor_id" class="form-label">Proveedor:</label>
                <select id="txtProveedor_id" name="proveedor" class="form-select" required>
                    <option value="{{ producto_tienda.proveedor.id }}" selected>{{ producto_tienda.proveedor.razon_social }}</option>
                    {% for proveedor in proveedores %}
                        <option value="{{ proveedor.id }}">{{ proveedor.razon_social }}</option>
                    {% endfor %}
                </select>
                <label for="txtPrecioUnitario" class="form-label">Precio Unitario:</label>
                <input type="text" step="0.01" id="txtPrecioUnitario" name="precio_unitario" class="form-control" value="{{ form.precio_unitario.value }}" required>
                <label for="txtCantidad" class="form-label">Cantidad:</label>
                <input type="number" id="txtCantidad" name="cantidad" class="form-control" value="{{ producto_tienda.cantidad }}" required>
                <label for="txtStockMinimo" class="form-label">Stock Mínimo:</label>
                <input type="number" id="txtStockMinimo" name="stock_minimo" class="form-control" value="{{ producto_tienda.stock_minimo }}" required>
                <label for="txtEstado" class="form-label">Estado:</label>
                <select id="txtEstado" name="estado" class="form-select" required>
                    <option value="activo" {% if producto_tienda.estado == 'activo' %} selected {% endif %}>Activo</option>
                    <option value="inactivo" {% if producto_tienda.estado == 'inactivo' %} selected {% endif %}>Inactivo</option>
                </select>
            </div>
        </div>
        <div class="mb-3 d-flex justify-content-between">
            <button type="submit" class="producto-edit-btn">Guardar Cambios</button>
            <button type="button" class="btn btn-secondary" onclick="window.location.href='{% url 'index_producto' %}'">Volver</button>
            <form action="{% url 'eliminar_producto' producto_tienda.id %}" method="POST" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="producto-edit-btn producto-edit-btn-danger" onclick="return confirm('¿Estás seguro de que deseas eliminar este producto? Esta acción no se puede deshacer.');">Eliminar Producto</button>
            </form>
        </div>
        <div class="producto-edit-divider"></div>
        <!-- Mostrar Promoción Activa si existe -->
        {% if promociones_activas %}
            <div class="promociones-contenedor">
                <h5 class="text-primary">Promociones Activas para este Producto:</h5>
                {% for promocion in promociones_activas %}
                    <div class="card mb-3 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title text-success">
                                <i class="fas fa-tags"></i> {{ promocion.nombre }}
                            </h5>
                            <p class="card-text">{{ promocion.descripcion }}</p>
                            <div class="mb-2">
                                <span class="badge bg-warning text-dark">
                                    <strong>Descuento:</strong> {{ promocion.descuento_porcentaje }}%
                                </span>
                            </div>
                            <p class="text-muted">
                                <i class="fas fa-calendar-alt"></i> Válido hasta: {{ promocion.fecha_fin|date:"d M Y" }}
                            </p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle"></i> Este producto no tiene promociones activas en este momento.
            </div>
        {% endif %}
    </form>
</div>
<script>
function previewImage(event) {
    var reader = new FileReader();
    var imagePreview = document.getElementById('imagen-preview');
    var imageStatus = document.getElementById('imagen-status');
    if (event.target.files && event.target.files[0]) {
        reader.onload = function(e) {
            imagePreview.src = e.target.result;
            imagePreview.alt = 'Nueva Imagen Seleccionada';
            imageStatus.textContent = 'Imagen a Modificar';
        };
        reader.readAsDataURL(event.target.files[0]);
    } else {
        var currentImageSrc = "{{ producto_tienda.imagen.url }}";
        imagePreview.src = currentImageSrc ? currentImageSrc : "{% static 'default-image.png' %}";
        imageStatus.textContent = currentImageSrc ? 'Imagen Actual' : 'Sin Imagen Actual';
    }
}
document.getElementById('imagen').addEventListener('change', previewImage);
</script>
{% endblock %}
