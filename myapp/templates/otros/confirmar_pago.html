{% extends 'base.html' %}
{% block content %}
    {% load static %}
    <style>
        body {
            background: #f6f8fa;
        }
        .minimal-card {
            border: none;
            border-radius: 18px;
            box-shadow: 0 2px 16px 0 rgba(60,72,88,.08);
            background: #fff;
        }
        .minimal-card-header {
            background: linear-gradient(90deg, #2563eb 0%, #1e293b 100%);
            color: #fff;
            border-radius: 18px 18px 0 0;
            padding: 1.5rem 2rem;
        }
        .minimal-table th, .minimal-table td {
            vertical-align: middle;
            border: none;
        }
        .minimal-table th {
            background: #f1f5f9;
            font-weight: 600;
            color: #334155;
        }
        .minimal-table tr {
            border-bottom: 1px solid #f1f5f9;
        }
        .minimal-table td {
            color: #475569;
        }
        .minimal-btn {
            border-radius: 8px;
            font-weight: 500;
            transition: background .2s;
        }
        .minimal-btn-primary {
            background: #2563eb;
            color: #fff;
            border: none;
        }
        .minimal-btn-primary:hover {
            background: #1e40af;
            color: #fff;
        }
        .minimal-btn-danger {
            background: #f87171;
            color: #fff;
            border: none;
        }
        .minimal-btn-danger:hover {
            background: #dc2626;
            color: #fff;
        }
        .minimal-section {
            background: #f1f5f9;
            border-radius: 12px;
            padding: 1.5rem;
        }
        .minimal-label {
            font-weight: 600;
            color: #334155;
        }
        .minimal-value {
            font-weight: 700;
            color: #2563eb;
        }
        .minimal-total {
            font-size: 1.3rem;
            color: #059669;
            font-weight: 700;
        }
        .minimal-form label {
            color: #334155;
            font-weight: 500;
        }
        .minimal-form input, .minimal-form select {
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .minimal-modal .modal-content {
            border-radius: 16px;
        }
    </style>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card minimal-card">
                    <div class="minimal-card-header">
                        <h3 class="mb-0"><i class="fa-solid fa-cart-shopping me-2"></i>Carrito de Compras</h3>
                    </div>
                    <div class="card-body p-4">
                        <div class="table-responsive mb-4">
                            <table id="tabla-carrito" class="table minimal-table align-middle">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>Cantidad</th>
                                        <th>Precio unitario</th>
                                        <th>Descuento</th>
                                        <th>Precio actualizado</th>
                                        <th>Precio total</th>
                                        <th>Opciones</th>
                                    </tr>
                                </thead>
                                <tbody id="cuerpo-tabla-carrito">
                                    {% if cart.items %}
                                        {% for item in cart.items %}
                                            <tr>
                                                <td>{{ item.product }}</td>
                                                <td>{{ item.quantity }}</td>
                                                <td>${{ item.price|floatformat:2 }}</td>
                                                <td>${{ item.total|floatformat:2 }}</td>
                                                <td>
                                                    <a href="{% url 'carton_remove' item.product.pk %}" class="btn btn-danger btn-sm">Eliminar</a>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr id="mensaje-vacio">
                                            <td colspan="5" class="text-center">Tu carrito está vacío.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="minimal-section mb-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="minimal-label">Subtotal:</span>
                                        <span class="minimal-value">$<span id="subtotal-carrito">{{ cart.total|floatformat:2 }}</span></span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="minimal-label">IVA (19%):</span>
                                        <span class="minimal-value">$<span id="iva-carrito">{{ iva|floatformat:2 }}</span></span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="minimal-label">Total:</span>
                                        <span class="minimal-total">$<span id="total-carrito">{{ total|floatformat:2 }}</span></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex flex-column align-items-end justify-content-between">
                                <div>
                                    <button id="vaciar-carrito" class="minimal-btn minimal-btn-danger me-2 mb-2">
                                        <i class="fas fa-trash"></i> Vaciar todo
                                    </button>
                                    <button id="boton-carrito" class="minimal-btn minimal-btn-primary mb-2">
                                        <i class="fa-solid fa-credit-card"></i> Proceder al Pago
                                    </button>
                                </div>
                                <div id="spinner" class="spinner-border text-primary mt-2" role="status" style="display: none;">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <div id="mensaje-exito" class="alert alert-success mt-2" role="alert" style="display: none;">
                                    Pago procesado con éxito.
                                </div>
                                <div id="mensaje-error" class="alert alert-danger mt-2" role="alert" style="display: none;">
                                    Ocurrió un error al procesar el pago. Inténtalo de nuevo.
                                </div>
                            </div>
                        </div>
                        <hr class="my-4">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <form class="minimal-form mb-3">
                                    <label for="metodo_pago" class="form-label">Método de pago</label>
                                    <select id="metodo_pago" name="metodo_pago" class="form-select">
                                        <option value="">Seleccione un método de pago</option>
                                        {% for metodo_pago in metodos_pago %}
                                            <option value="{{ metodo_pago.id }}">{{ metodo_pago.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </form>
                                <button class="minimal-btn minimal-btn-primary" id="agregar-nueva-direccion" data-bs-toggle="modal" data-bs-target="#modalNuevaDireccion">
                                    <i class="fa-solid fa-plus"></i> Agregar nueva dirección
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div id="direcciones-container" class="mb-3">
                                    <label class="minimal-label mb-2">Selecciona una dirección de envío:</label>
                                    <div class="list-group">
                                        {% for direccion in direcciones %}
                                            <div class="list-group-item">
                                                <input type="radio" id="direccion_{{ direccion.id }}" name="direccion" value="{{ direccion.id }}"
                                                    {% if direccion.id == direccion_principal.id %} checked {% endif %}>
                                                <label for="direccion_{{ direccion.id }}" class="ms-2">
                                                    <strong>Dirección:</strong> {{ direccion.direccion }}
                                                    <a href="#" class="ms-2 leer-mas-link" data-bs-toggle="collapse" data-bs-target="#info-direccion-{{ direccion.id }}" aria-expanded="false" aria-controls="info-direccion-{{ direccion.id }}">Leer más</a>
                                                    <div class="collapse mt-2" id="info-direccion-{{ direccion.id }}">
                                                        <div>
                                                            <strong>Ciudad:</strong> {{ direccion.ciudad }}<br>
                                                            <strong>Departamento:</strong> {{ direccion.departamento }}<br>
                                                            {% if direccion.codigo_postal %}
                                                                <strong>Código Postal:</strong> {{ direccion.codigo_postal }}
                                                            {% else %}
                                                                <strong>Código Postal:</strong> No especificado
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Modal para registrar nueva dirección -->
                        <div class="modal fade minimal-modal" id="modalNuevaDireccion" tabindex="-1" aria-labelledby="modalNuevaDireccionLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="registrarModalLabel">Registrar Nueva Dirección</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="direccionForm" method="POST" action="{% url 'registrar_direccion' %}">
                                            {% csrf_token %}
                                            <p id="modalDescription">Por favor, complete la información de la nueva dirección.</p>
                                            <div class="mb-3">
                                                <label for="id_direccion" class="form-label">Dirección</label>
                                                <input type="text" class="form-control" id="id_direccion" name="direccion" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="id_departamento" class="form-label">Departamento</label>
                                                <select class="form-control" id="id_departamento" name="departamento" required>
                                                    <option value="">Seleccione un departamento</option>
                                                    {% for departamento in departamentos %}
                                                        <option value="{{ departamento.id }}">{{ departamento.nombre }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="id_ciudad" class="form-label">Ciudad</label>
                                                <select class="form-control" id="id_ciudad" name="ciudad" required>
                                                    <option value="">Seleccione una ciudad</option>
                                                    <!-- Las opciones se llenarán dinámicamente -->
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="id_codigo_postal" class="form-label">Código Postal</label>
                                                <input type="text" class="form-control" id="id_codigo_postal" name="codigo_postal">
                                            </div>
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="id_principal" name="principal" value="on">
                                                <label class="form-check-label" for="id_principal">
                                                    ¿Hacer esta dirección principal?
                                                </label>
                                            </div>
                                            <button type="submit" class="minimal-btn minimal-btn-primary me-2">Registrar</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Fin Modal -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Scripts -->
    <script src="{% static 'myapp/js/confirmar_pago.js' %}"></script>
    <script src="{% static 'myapp/js/direccion.js' %}"></script>
    <script>
        var registrarDireccionUrl = "{% url 'registrar_direccion' %}";
    </script>
{% endblock %}
